<!DOCTYPE html>
<html>
  <head>
    <title>Solution Viewer</title>
    <style>
      html, body { font-family: sans-serif; }
      pre { border-radius: 0.5em; padding: 0.5em; background: #eee; }
      .scans {
        max-width: 630px;
      }
      .scans > .depth {
        display: flex;
        flex-direction: row;
      }
      .depth > * {
        flex: 1 1;
        white-space: nowrap;
      }
      .depth > b:first-of-type {
        flex: 0;
        min-width: 40px;
        margin-right: 1em;
        font-weight: normal;
      }
      .depth.increased {
        color: black;
        fill: #9AF;
      }
      .depth.decreased {
        color: #999;
        fill: #89F;
      }
      .depth.no.change {
        fill: #ABF;
      }
      .depth.no.previous.sum {
        color: #A00;
        fill: red;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  </head>
  <body>
    <div id="viewer">
      <h1>Solution Viewer ({{ solutionTitle }})</h1>
      <p>For interesting problems; this page can be used as a dynamic viewer.</p>
      <h2>Solution 1 : {{ solution1.solution }}</h2>
      <p>Showing first {{ display }}:</p>
      <div class="scans" v-if="solution1">
        <svg :width="displayWidth(solution1)" :height="(maxDepth(solution1.depths) / 10) + skyHeight * 2">
          <rect :width="displayWidth(solution1)" :height="(maxDepth(solution1.depths) / 10) + skyHeight * 2" fill="black" />
          <rect :width="displayWidth(solution1)" :height="skyHeight" fill="skyblue" />
          <g :transform="`translate(0, ${skyHeight})`">
            <rect v-for="(depth, idx) in scanWindow(solution1.depths)" :key="`sc1-${idx}`"
              width="10"
              :height="depth.scan / 10"
              :transform="`translate(${idx * 10} 0)`"
              :class="`depth ${describe(depth)}`">
          </g>
          <g :transform="`translate(${boat.x}, ${skyHeight - 5})`">
            <path fill="yellow" d="M-15 -3 L15 -3 L10 5 L-10 5" />
            <rect fill="black" width="3" height="10" y="-13" />
            <path fill="orange" d="M0 -4 L-10 -4 L0 -13" />
          </g>
        </svg>
      </div>
      <h2>Solution 2 : {{ solution2.solution }}</h2>
      <p>Showing first {{ display }}:</p>
      <div class="scans" v-if="solution2"></div>
        <svg :width="displayWidth(solution2)" :height="(maxDepth(solution2.depths) / 10) + skyHeight * 2">
          <rect :width="displayWidth(solution2)" :height="(maxDepth(solution2.depths) / 10) + skyHeight * 2" fill="black" />
          <rect :width="displayWidth(solution2)" :height="skyHeight" fill="skyblue" />
          <g :transform="`translate(0, ${skyHeight})`">
            <rect v-for="(depth, idx) in scanWindow(solution2.depths)" :key="`sc1-${idx}`"
              width="10"
              :height="depth.scan / 10"
              :transform="`translate(${idx * 10} 0)`"
              :class="`depth ${describe(depth)}`">
          </g>
          <g :transform="`translate(${boat.x}, ${skyHeight - 5})`">
            <path fill="yellow" d="M-15 -3 L15 -3 L10 5 L-10 5" />
            <rect fill="black" width="3" height="10" y="-13" />
            <path fill="orange" d="M0 -4 L-10 -4 L0 -13" />
          </g>
        </svg>
      </div>
      <h3><a href="./input.txt">input.txt</a></h3>
      <h3><a href="./solution.js">solution.js</a></h3>
      <pre><code>{{ solutionText }}</code></pre>
    </div>
    <script>
const app = new Vue({
  el: '#viewer',
  data: () => {
    return {
      timer: 0,
      skyHeight: 100,
      display: 100,
      solutionText: '[Loading]',
      inputText: '[Loading]',
      solution1: false,
      solution2: false
    }
  },
  computed: {
    solutionTitle() {
      const parts = (document.location + '').split('/')
      return parts.reverse()[1]
    },
    boat() {
      const scans = this.solution1.depths || []
      const offset = this.timer % scans.length
      return {
        x: (140 + offset) || 40
      }
    }
  },
  methods: {
    describe(depth) {
      if (depth.diff === 0) {
        return 'no change'
      }
      if (!depth.diff) {
        return 'N/A - no previous sum'
      }
      return depth.diff > 0 ? 'increased' : 'decreased' 
    },
    scanWindow(depths) {
      const { display, boat } = this
      const list = depths || []
      const start = Math.floor(boat.x)
      const end = start + display
      return list.slice(start, end)
    },
    maxDepth(depths) {
      const list = depths || []
      return Math.max(...list.map(d => d.scan), 10)
    },
    displayWidth(solution) {
      return this.display * 10
    }
  },
  async mounted () {
    this.solutionText = (await axios.get('./solution.js')).data
    this.inputText = (await axios.get('./input.txt')).data
    this.solution1 = await solveForFirstStar(this.inputText)
    this.solution2 = await solveForSecondStar(this.inputText)

    const self = this
    setInterval(() => {
      self.timer = self.timer + 2
    }, 25)
  }
})

function parseDepths (input) {
  const depths = input.split('\n').map(n => Number.parseInt(n)).map(n => {
    return {
      scan: n
    }
  })

  depths.forEach((depth, index) => {
    const previousDepth = depths[index - 1] || { scan: NaN }
    depth.diff = depth.scan - previousDepth.scan
  })

  return depths
}

async function solveForFirstStar (input) {
  const depths = parseDepths(input)
  const solution = depths.filter(d => d.diff > 0).length

  return {
    solution,
    depths
  }
}

async function solveForSecondStar (input) {
  const depths = parseDepths(input)

  depths.forEach((depth, index) => {
    const p1 = depth
    const p2 = depths[index - 1] || { scan: NaN }
    const p3 = depths[index - 2] || { scan: NaN }
    depth.window = p1.scan + p2.scan + p3.scan
  })

  depths.forEach((depth, index) => {
    const previousDepth = depths[index - 1] || { scan: 0 }
    depth.diff = depth.window - previousDepth.window
  })

  const solution = depths.filter(d => d.diff > 0).length
  return {
    solution,
    depths
  }
}
    </script>
  </body>
</html>